name: Build Windows EXE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install FFmpeg
      run: |
        choco install ffmpeg --version=7.0.1 --no-progress
        ffmpeg -version

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel
        pip install PyQt5 --only-binary all
        pip install numpy opencv-python Pillow requests flask pyyaml python-dotenv aiohttp rich --only-binary all
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu --only-binary all
        pip install pyinstaller

    - name: Verify files exist
      run: |
        dir outputs\
        dir prompts\
        type src\chronogrid\interfaces\gui.py | findstr /c:"PyQt5" | head -1

    - name: Build EXE
      run: |
        pyinstaller --onefile --windowed --name chronogrid-gui.exe src/chronogrid/interfaces/gui.py --hidden-import PyQt5.QtCore --hidden-import PyQt5.QtWidgets --hidden-import PyQt5.QtGui --hidden-import numpy --hidden-import cv2 --hidden-import torch

    - name: Check build output
      run: |
        dir dist\
        if exist dist\chronogrid-gui.exe (echo EXE created successfully) else (echo EXE not found && exit 1)

    - name: Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: chronogrid-gui-exe
        path: dist/chronogrid-gui.exe
        retention-days: 30
